#!/usr/bin/python

import os
import SimpleHTTPServer
import SocketServer

class _Handler(SimpleHTTPServer.SimpleHTTPRequestHandler):
    def do_GET(self):
        self.send_response(301)
        new_path = '%s%s' % (self.server.redirect_host, self.path)
        self.send_header('Location', new_path)
        self.end_headers()

class _Server(SocketServer.TCPServer):
    allow_reuse_address = True

    def __init__(self, server_address, redirect_host):
        if 'WEBREDIRECT_TEST' in os.environ:
            server_address = ('127.0.0.1', 7999)
        SocketServer.TCPServer.__init__(self, server_address, _Handler)
        self.redirect_host = redirect_host

if __name__ == "__main__":
    import argparse
    parser = argparse.ArgumentParser()
    parser.add_argument('--redirect-host', required=True,
                        help='host redirect address (fully specified, includes http://)')
    parser.add_argument('--redirect-port', default=80, type=int,
                        help='host redirect port (default: 80)')
    args = parser.parse_args()
                        
    host = args.redirect_host
    if args.redirect_port != 80:
        host = '%s:%d' % (host, args.redirect_port)

    httpd = _Server(("0.0.0.0", 80), redirect_host=host)
    try:
        httpd.serve_forever()
    except KeyboardInterrupt:
        pass

